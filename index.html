<!DOCTYPE html>
<html lang="hi">
<head>
  <!-- [Previous head content remains exactly the same until the closing </style> tag] -->
</head>
<body>

<!-- [All your previous HTML content remains exactly the same until the Firebase SDK scripts] -->

<!-- Updated Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBcdSsQTepHActnokxV5F1YS3zeBOBkoQg",
    authDomain: "ruptoken-5e3a0.firebaseapp.com",
    databaseURL: "https://ruptoken-5e3a0-default-rtdb.firebaseio.com",
    projectId: "ruptoken-5e3a0",
    storageBucket: "ruptoken-5e3a0.appspot.com",
    messagingSenderId: "719313334393",
    appId: "1:719313334393:web:7a50e9369e87254eb824a8",
    measurementId: "G-4B8RSJKGEP"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const auth = firebase.auth();

  // Global variables
  let hasSpun = false;
  let currentUserRewards = {};

  // Check auth state
  auth.onAuthStateChanged((user) => {
    if (user) {
      console.log("User signed in:", user.uid);
      showProfile(user);
      loadUserRewards(user.uid);
      checkDailySpinEligibility(user.uid);
    } else {
      console.log("No user signed in");
      showLogin();
    }
  });

  // Check if user can spin today
  function checkDailySpinEligibility(userId) {
    database.ref('users/' + userId + '/lastSpinDate').once('value').then((snapshot) => {
      const lastSpinDate = snapshot.val();
      const today = new Date().toDateString();
      
      if (lastSpinDate === today) {
        hasSpun = true;
        document.getElementById('spinBtn').disabled = true;
        document.getElementById('result').innerText = "आज आप स्पिन कर चुके हैं, कल फिर आएं!";
      } else {
        hasSpun = false;
        document.getElementById('spinBtn').disabled = false;
      }
    });
  }

  // Save reward with auto-completion after 1 minute
  function saveRewardWithAutoComplete(userId, prize) {
    const rewardRef = database.ref('users/' + userId + '/rewards').push();
    const timestamp = new Date().toLocaleString();
    const rewardId = rewardRef.key;
    
    const rewardData = {
      id: rewardId,
      prize: prize,
      date: timestamp,
      status: "Pending",
      claimed: false
    };
    
    rewardRef.set(rewardData).then(() => {
      console.log("Reward saved as Pending");
      
      // Auto-complete after 1 minute
      setTimeout(() => {
        if (!currentUserRewards[rewardId]?.claimed) {
          rewardRef.update({ 
            status: "Completed",
            completedDate: new Date().toLocaleString()
          }).then(() => {
            console.log("Reward auto-updated to Completed");
            loadUserRewards(userId); // Refresh rewards list
          });
        }
      }, 60000); // 1 minute = 60,000 ms
    });
    
    // Update last spin date
    database.ref('users/' + userId).update({
      lastSpinDate: new Date().toDateString()
    });
  }

  // [Keep all your previous functions until the loadUserRewards function]

  // Enhanced loadUserRewards function with claim button
  function loadUserRewards(userId) {
    database.ref('users/' + userId + '/rewards').on('value', (snapshot) => {
      const rewards = snapshot.val();
      const rewardsList = document.getElementById('rewardsList');
      currentUserRewards = rewards || {};
      
      if (!rewards) {
        noRewardsMsg.style.display = 'block';
        rewardsList.innerHTML = '';
        return;
      }
      
      noRewardsMsg.style.display = 'none';
      rewardsList.innerHTML = '';
      
      Object.entries(rewards).forEach(([key, reward]) => {
        const rewardItem = document.createElement('div');
        rewardItem.className = 'reward-item';
        rewardItem.id = 'reward-' + reward.id;
        
        let claimButton = '';
        if (reward.status === "Completed" && !reward.claimed) {
          claimButton = `<button onclick="claimReward('${userId}', '${reward.id}')" class="claim-btn">Claim</button>`;
        }
        
        rewardItem.innerHTML = `
          <div>
            <span class="reward-prize">${reward.prize}</span>
            <span class="reward-date">${reward.date}</span>
          </div>
          <div>
            <span class="reward-status ${reward.status.toLowerCase()}">${reward.status}</span>
            ${claimButton}
          </div>
        `;
        rewardsList.appendChild(rewardItem);
      });
    });
  }

  // New function to handle reward claiming
  function claimReward(userId, rewardId) {
    if (!userId || !rewardId) return;
    
    database.ref('users/' + userId + '/rewards/' + rewardId).update({
      claimed: true,
      claimedDate: new Date().toLocaleString()
    }).then(() => {
      alert("पुरस्कार सफलतापूर्वक क्लेम हो गया!");
      loadUserRewards(userId); // Refresh the rewards list
    }).catch((error) => {
      console.error("Error claiming reward:", error);
      alert("पुरस्कार क्लेम करने में त्रुटि: " + error.message);
    });
  }

  // [Keep all your remaining functions exactly the same]

  // Add this new CSS for reward items
  const style = document.createElement('style');
  style.textContent = `
    .reward-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .reward-prize {
      font-weight: bold;
      color: #2e7d32;
    }
    .reward-date {
      font-size: 12px;
      color: #666;
      display: block;
      margin-top: 4px;
    }
    .reward-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .reward-status.pending {
      background: #fff8e1;
      color: #ff8f00;
    }
    .reward-status.completed {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .claim-btn {
      padding: 6px 12px;
      background: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 8px;
      transition: all 0.3s;
    }
    .claim-btn:hover {
      background: #3e8e41;
      transform: scale(1.05);
    }
  `;
  document.head.appendChild(style);

  // Initialize
  spinBtn.addEventListener("click", rotateWheel);
  drawWheel();
</script>
</body>
</html>
